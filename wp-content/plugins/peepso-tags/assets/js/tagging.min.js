!function(a,b,c,d){var e=d(a,b,c);a.fn.ps_tagging=function(b,c){return"object"==typeof b&&(c=b),this.each(function(){var d=a(this),f=d.data("ps_tagging");f||(f=new e(this,c),d.data("ps_tagging",f)),"val"===b&&"function"==typeof c?c(f.val()):"reset"===b&&f.reset()})}}(jQuery||$,_,peepso,function(a,b,c){function d(a,b){return this.textarea=a,this.options=b||{},this.init(),this}var e=13,f=27,g=38,h=40,i=/@\[\[(\d+):user:([^\]]+)\]\]/g,j=/@\[\[(\d+):user:([^\]]+)\]\]/,k=/\n/g,l="<br>",m="@",n=".ps-tagging",o=".ps-tagging-textarea",p=".ps-tagging-wrapper",q=".ps-tagging-beautifier",r=".ps-tagging-hidden",s=".ps-tagging-dropdown",t=".ps-tagging-dropdown-item",u=".active",v=".ps-tagging-loading";return d.prototype.init=function(){this.dom_prepare(),this.textarea.value&&(this.parse_tags(),this.textarea_on_input()),this.$textarea.off(n).on("focus"+n,a.proxy(this.textarea_on_keydown,this)).on("click"+n,a.proxy(this.textarea_on_keydown,this)).on("keydown"+n,a.proxy(this.textarea_on_keydown,this)).on("keyup"+n,a.proxy(this.textarea_on_keyup,this)).on("input"+n,a.proxy(this.textarea_on_input,this)).on("blur"+n,a.proxy(this.textarea_on_blur,this)),this.$dropdown.off(n).on("mouseenter"+n,t,a.proxy(this.dropdown_on_mouseenter,this)).on("mousedown"+n,t,a.proxy(this.dropdown_on_mousedown,this)).on("mouseup"+n,t,a.proxy(this.dropdown_on_mouseup,this))},d.prototype.dom_prepare=function(){this.$textarea=a(this.textarea),this.$textarea.addClass(o.substr(1)),this.$wrapper=this.$textarea.parent(p),this.$wrapper.length||(this.$textarea.wrap('<div class="'+p.substr(1)+'"></div>'),this.$wrapper=this.$textarea.parent()),this.$beautifier=this.$wrapper.children(q),this.$beautifier.length||(this.$beautifier=a('<div class="'+q.substr(1)+'"></div>'),this.$beautifier.prependTo(this.$wrapper)),this.$hidden=this.$wrapper.children(r),this.$hidden.length||(this.$hidden=a('<input type="hidden" class="'+r.substr(1)+'">'),this.$hidden.appendTo(this.$wrapper)),this.$dropdown=this.$wrapper.children(s),this.$dropdown.length||(this.$dropdown=a('<div class="'+s.substr(1)+'"></div>'),this.$dropdown.appendTo(this.$wrapper))},d.prototype.parse_tags=function(){var a,b,c,d,e,f,e=this.textarea.value,g=this.options.parser;if(g&&(a=this.options.parser_groups||{},e=e.replace(this.options.parser,function(){return"@[["+(arguments[a.id]||"")+":user:"+(arguments[a.title]||"")+"]]"})),b=e.match(i),this.textarea.value=e.replace(i,"$2"),this.tags_added=[],b&&b.length)for(f=0;f<b.length;f++)c=b[f].match(j),d=e.indexOf(b[f]),e=e.replace(b[f],c[2]),this.tags_added.push({id:c[1],name:c[2],start:d,length:c[2].length})},d.prototype.reset=function(){var a=this.textarea.value="",b=this.tags_added=[];this.beautifier_update(a,b),this.hidden_update(a,b),this.dropdown_hide()},d.prototype.val=function(){var b=this.$hidden.val();return"function"==typeof this.options.syntax&&(b=b.replace(/@\[\[(\d+):user:([^\]]+)\]\]/g,a.proxy(function(a,b,c){return this.options.syntax({id:b,title:c})},this))),b},d.prototype.textarea_on_keydown=function(a){var b=a.keyCode;this.dropdown_is_visible&&[e,f,g,h].indexOf(b)>=0&&(a.preventDefault(),a.stopPropagation()),this.prev_sel_start=this.textarea.selectionStart,this.prev_sel_end=this.textarea.selectionEnd},d.prototype.textarea_on_keyup=function(a){var b=a.keyCode;this.dropdown_is_visible&&((b===g||b===h)&&(this.dropdown_change_item(b),a.preventDefault(),a.stopPropagation()),b===e&&(this.dropdown_select_item(),a.preventDefault(),a.stopPropagation()),b===f&&(this.dropdown_hide(),a.preventDefault(),a.stopPropagation()))},d.prototype.textarea_on_input=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this.textarea.value;if(this.tags_added){if(this.prev_sel_start!==this.prev_sel_end)for(k=0;k<this.tags_added.length;k++)c=this.tags_added[k],d=c.start+c.length,(this.prev_sel_start>c.start&&this.prev_sel_start<d||this.prev_sel_end>c.start&&this.prev_sel_end<d||c.start>=this.prev_sel_start&&d<=this.prev_sel_end)&&this.tags_added.splice(k--,1);for(b=this.textarea.selectionStart-this.prev_sel_start-(this.prev_sel_end-this.prev_sel_start),k=0;k<this.tags_added.length;k++)if(c=this.tags_added[k],c.start>=this.prev_sel_start)c.start+=b;else if(d=c.start+c.length,d<this.prev_sel_start);else if(d>this.prev_sel_start){if(b>0)this.tags_added.splice(k--,1);else if(0>b){for(e=m.substring(c.start,this.prev_sel_start+b),g=e.split(" ").length-1,e=c.name.split(" "),e.splice(g,1),e=e.join(" "),f=c.name.split(" "),f=f.slice(0,g),f=f.join(" "),h=new RegExp("^([\\s\\S]{"+c.start+"})([\\s\\S]{"+(c.length+b)+"})"),i="$1"+e,this.textarea.value=this.textarea.value.replace(h,i),this.textarea.setSelectionRange(c.start+f.length,c.start+f.length),m=this.textarea.value,j=c.length-e.length,c.name=e,c.length=e.length,l=k+1;l<this.tags_added.length;l++)this.tags_added[l].start-=j;e.length||this.tags_added.splice(k--,1),k=this.tags_added.length}}else if(0>b){for(e=c.name.split(" "),e.pop(),e=e.join(" "),h=new RegExp("^([\\s\\S]{"+c.start+"})([\\s\\S]{"+(c.length+b)+"})"),i="$1"+e,this.textarea.value=this.textarea.value.replace(h,i),this.textarea.setSelectionRange(c.start+e.length,c.start+e.length),m=this.textarea.value,j=c.length-e.length,c.name=e,c.length=e.length,l=k+1;l<this.tags_added.length;l++)this.tags_added[l].start-=j;e.length||this.tags_added.splice(k--,1),k=this.tags_added.length}}this.beautifier_update(m,this.tags_added||[]),this.hidden_update(m,this.tags_added||[]),this.dropdown_toggle()},d.prototype.textarea_on_blur=function(a){},d.prototype.beautifier_update=b.debounce(function(a,b){var c,d,e,f,g;if(b.length){for(c="^",d="",e=0,g=0;g<b.length;g++)f=b[g],c+="([\\s\\S]{"+(f.start-e)+"})([\\s\\S]{"+f.length+"})",d+="$"+(2*g+1)+'<span class="ps-tag">'+f.name+"</span>",e=f.start+f.length;c=new RegExp(c),a=a.replace(c,d)}a=a.replace(k,l),this.$beautifier.html(a)},1),d.prototype.hidden_update=b.debounce(function(a,b){var c,d,e,f,g;if(b.length){for(c="^",d="",e=0,g=0;g<b.length;g++)f=b[g],c+="([\\s\\S]{"+(f.start-e)+"})([\\s\\S]{"+f.length+"})",d+="$"+(2*g+1)+"@[["+f.id+":user:"+f.name+"]]",e=f.start+f.length;c=new RegExp(c),a=a.replace(c,d)}this.$hidden.val(a)},50),d.prototype.dropdown_toggle=b.debounce(function(){var b=this.textarea.selectionStart,c=this.textarea.value.substr(0,b),d=c.lastIndexOf(m);return 0>d||++d>=b?void this.dropdown_hide():(c=c.substring(d,b),void this.dropdown_fetch(c,a.proxy(this.dropdown_update,this)))},200),d.prototype.dropdown_fetch=function(b,c){return"function"!=typeof this.options.fetcher?void c(b,[]):void(this.dropdown_fetching||(this.dropdown_fetching=!0,this.$dropdown.find(v).show(),this.options.fetcher(b,a.proxy(function(a,d){this.$dropdown.find(v).hide(),this.dropdown_fetching=!1,"cache"===d?c(b,a):this.dropdown_toggle()},this))))},d.prototype.dropdown_filter=function(a,c){var d=[];return this.tags_added&&this.tags_added.length&&(d=b.map(this.tags_added,function(a){return""+a.id})),a=a.toLowerCase(),b.filter(c,function(b){return-1===d.indexOf(""+b.id)&&b.name.toLowerCase().indexOf(a)>-1})},d.prototype.dropdown_update=function(a,b){var c,d;if(b=this.dropdown_filter(a,b),b.length){for(c="",d=0;d<b.length;d++)c+='<div class="'+t.substr(1)+'" data-id="'+b[d].id+'" data-name="'+b[d].name+'">',c+='<a href="javascript:"><div class="ps-avatar"><img src="'+b[d].avatar+'"></div><span>'+b[d].name+"</span></a>",c+="</div>";this.dropdown_show(c)}},d.prototype.dropdown_show=function(a){this.$dropdown.html(a).show(),this.dropdown_is_visible=!0},d.prototype.dropdown_show_more=function(){},d.prototype.dropdown_hide=function(){this.$dropdown.hide(),this.dropdown_is_visible=!1},d.prototype.dropdown_on_mouseenter=function(a){this.dropdown_change_item(a)},d.prototype.dropdown_on_mousedown=function(){this.dropdown_is_clicked=!0},d.prototype.dropdown_on_mouseup=function(a){this.dropdown_select_item(a),this.dropdown_is_clicked=!1,this.dropdown_hide()},d.prototype.dropdown_change_item=function(b){var c,d,e,f=u.substr(1);return"number"!=typeof b?(c=this.dropdown_selected_item=a(b.target),d=c.siblings(u),c.addClass(f),void d.removeClass(f)):(c=this.$dropdown.children(u),c.length?(e=c[b===g?"prev":"next"](),c.removeClass(f),void(e.length?(this.dropdown_selected_item=e,e.addClass(f)):this.dropdown_selected_item=!1)):(c=this.dropdown_selected_item=this.$dropdown.children()[b===g?"last":"first"](),void c.addClass(f)))},d.prototype.dropdown_select_item=function(b){var c,d,e=b?a(b.currentTarget):this.dropdown_selected_item,f=e.data("id"),g=e.data("name"),h=this.textarea.selectionStart,i=this.textarea.value.substr(0,h),j=i.lastIndexOf(m);this.tags_added||(this.tags_added=[]),this.tags_added.push({id:f,name:g,start:j,length:g.length}),c=new RegExp("^([\\s\\S]{"+j+"})[\\s\\S]{"+(h-j)+"}"),d=this.textarea.value.replace(c,"$1"+g),this.textarea.value=d,this.textarea.setSelectionRange(j+g.length,j+g.length),this.beautifier_update(d,this.tags_added),this.hidden_update(d,this.tags_added),this.dropdown_hide(),this.$textarea.focus()},d});