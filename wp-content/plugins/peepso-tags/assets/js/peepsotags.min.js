!function(a,b,c){c(a,b)}(jQuery||$,peepso,function(a,b){function c(){}c.prototype.init=function(){var b=this;this.taggable_inputs=ps_observer.apply_filters("peepsotags_taggable_inputs",["#postbox-main textarea.ps-postbox-textarea"]),this.init_tags(this.taggable_inputs.join(",")),this.init_tags_comments(),a(document).on("peepso_tags_init_comments ps_activitystream_append ps_activitystream_loaded",function(){b.init_tags_comments()}),ps_observer.add_filter("postbox_req_edit",function(a,b){return b.ps_tagging("val",function(b){a.post=b}),a},10,2),ps_observer.add_filter("comment_req",function(b,c){return a(c).ps_tagging("val",function(a){b.content=a,b.post=a}),b},10,2),ps_observer.add_filter("comment_cancel",function(b){a(b).ps_tagging("reset")},10,2),ps_observer.add_filter("modalcomments.afterchange",function(a){a&&a.$attachment&&a.$attachment.find(".ps-comment-reply textarea").ps_tagging()},10,2),ps_observer.add_filter("caption_req",function(b,c){return a(c).ps_tagging("val",function(a){b.description=a}),b},10,2),a("#peepso-wrap").on("comment.saved",function(b,c,d,e){a(d).ps_tagging("reset")}),a("#peepso-wrap").on("post_edit.shown , comment_edit.shown",function(a,c,d){var e=d.find("textarea");b.init_tags(e)})},c.prototype.init_tags=function(c){var d,e=!1,f=!1;a(c).one("focus.get_taggable",function(){e=!0,b.getJson("tagsajax.get_taggable",{},function(a){a.success&&(d=a.data.users),"function"==typeof f&&f(d||[]),e=!1})}),a(c).ps_tagging({syntax:_.template(peepsotags.template),parser:new RegExp(peepsotags.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(a,c){return d?void c(d,"cache"):e?void(f=c):void b.getJson("tagsajax.get_taggable",{},function(a){a.success&&(d=a.data.users),c(d||[])})}})},c.prototype.init_tags_comments=function(){a('[data-type="stream-newcomment"] textarea[name="comment"]').each(function(c,d){var e,f=!1,g=!1;a(d).one("focus.get_taggable",function(){var c={act_id:a(d).data("act-id")};f=!0,b.getJson("tagsajax.get_taggable",c,function(a){a.success&&(e=a.data.users),"function"==typeof g&&g(e||[]),f=!1})}),a(d).ps_tagging({syntax:_.template(peepsotags.template),parser:new RegExp(peepsotags.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(c,h){if(e)return void h(e,"cache");if(f)return void(g=h);var i={act_id:a(d).data("act-id")};b.getJson("tagsajax.get_taggable",i,function(a){a.success&&(e=a.data.users),h(e||[])})}}),ps_observer.add_filter("comment_can_submit",function(b){var c=a(b.el).data("ps_tagging");return b.can_submit=!c.dropdown_is_visible,b},10,1),a(d).ps_autosize()})},c.prototype.apply_line_breaks=function(a){function b(a){return d.value=a,d.scrollWidth>g}function c(a,d,e){var f;if("undefined"==typeof d)d=0,e=-1,f=64;else if(-1===e)f=2*d;else{if(1>=e-d)return Math.max(2,e);f=d+(e-d)/2}var g=a.substr(0,f),h=b(g);if(h)e=f;else{if(f>=a.length)return null;d=f}return c(a,d,e)}var d=a;d.wrap?d.setAttribute("wrap","off"):d.setAttribute("wrap","off");var e=d.value;d.value="";for(var f,g=d.scrollWidth,h=-1,i=0,j="";i<e.length;){var k=c(e.substr(i));if(null===k){j+=e.substr(i);break}h=-1;var l=k-1;for(f=l-1;f>=0;f--){var m=e.charAt(i+f);if(" "===m||"-"===m||"+"===m){l=f+1;break}}j+=e.substr(i,l)+"\n",i+=l}d.value=j,d.setAttribute("wrap","")},a(function(){var b=new c;b.init(),a(".ps-postbox-tab.interactions .ps-button-cancel").on("click",function(){a("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")}),a("#postbox-main .postbox-submit").on("click",function(){a("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")}),ps_observer.add_filter("#postbox-main-postbox_req",function(b){return a("#postbox-main textarea.ps-postbox-textarea").ps_tagging("val",function(a){b.content=a}),b},10,1)})});