!function(a,b,c){var d=c(a,b);pslocation=new d}(window,jQuery,function(a,b){function c(){this.coords=null,this.$places_container=null,this.$input_search=null,this.marker=null,this.map=null,this.selected_place=null,this._search_service=null,this._latLang=null,this.last_selected_place=null,this.location_selected=!1,this.can_submit=!1}return c.prototype.init=function(){if(!_.isNull(this.$postbox)){var a=this;ps_observer.add_filter("peepso_postbox_can_submit",function(b){return b.soft.push(a.can_submit),b},30,1),b(this.$postbox).on("click","#location-tab a",function(){a.toggle_input()}),this.$input_search=b("#postbox_loc_search",this.$postbox),this.$container=b("#pslocation",this.$postbox),this.$postboxcontainer=this.$postbox.$textarea.parent(),this.$places_container=b(".ps-postbox-locations",this.$container);var c=null;this.$input_search.on("keyup",function(){var d=this;clearTimeout(c);var e=b("<li>"+b("#pslocation-search-loading").html()+"</li>");a.$places_container.html(e),c=setTimeout(function(){a.location_search(b(d).val())},1500)}),ps_observer.add_filter(this.$postbox.selector+"-postbox_req",function(b,c){return a.postbox_request(b,c)},10,1),this.$postbox.on("postbox.post_cancel postbox.post_saved",function(b,c,d){a.postbox_cancel_saved(c,d)}),this.$select_location=b(".ps-location-action .ps-add-location",this.$container),this.$remove_location=b(".ps-location-action .ps-remove-location",this.$container),this.$select_location.on("click",function(b){b.preventDefault(),a.on_select_location()}),this.$remove_location.on("click",function(b){b.preventDefault(),a.on_remove_location()}),b(this.$postbox).on("peepso.interaction-hide","#location-tab a",function(){a.$container.addClass("hidden")}),ps_observer.add_filter("peepso_postbox_addons_update",function(b){return a.location_selected&&b.unshift("<b>"+a.location_selected+"</b>"),b},10,1)}},c.prototype.postbox_request=function(a,b){return null!==this.selected_place&&(a.location={name:this.selected_place.name,latitude:this.selected_place.geometry.location.lat(),longitude:this.selected_place.geometry.location.lng()}),a},c.prototype.postbox_cancel_saved=function(a,b){this.$container.addClass("hidden"),this.$input_search.val(""),this.$remove_location.hide(),this.$select_location.show(),this.$postboxcontainer.find("span#postlocation").remove(),this.selected_place=null,this.location_selected=!1,this.can_submit=!1,this.$postbox.on_change()},c.prototype.set_postbox=function(a){this.$postbox=a},c.prototype.location_search=function(a,b){var c=this;return _.isEmpty(a)?void this.draw_map(this._latLang):void this.get_search_service().textSearch({query:a,location:this._latLang,radius:5e4},function(a,d){c.set_places(a,d),c.$select_location.is(":visible")||c.$places_container.find("li").first().trigger("click"),typeof Function==typeof b&&b()})},c.prototype.on_select_location=function(){null===this.selected_place&&(this.selected_place=this.last_selected_place),this.$select_location.hide(),this.$remove_location.show(),this.$container.addClass("hidden"),this.location_selected=b("#pslocation-in-text").text()+(null!==this.selected_place?this.selected_place.name:""),this.can_submit=!0,this.$postbox.on_change()},c.prototype.on_remove_location=function(){this.$select_location.show(),this.$remove_location.hide(),this.selected_place=null,this.$postboxcontainer.find("span#postlocation").remove(),this.$container.addClass("hidden"),this.location_selected=!1,this.can_submit=!1,this.$postbox.on_change()},c.prototype.toggle_input=function(){if(this.$container.toggleClass("hidden"),this.$input_search.val(""),this.location=null,!this.$container.hasClass("hidden")){var a=this;this.load_library(function(){a.shown()}.bind(a))}},c.prototype.shown=function(){var a=this;this.$input_search.focus(),!1!==_.isEmpty(this.map)&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){a.coords=b.coords;var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);a.draw_map(c)},function(){a.draw_default_map()}):geoPosition.init()?(b("#pslocation .ps-postbox-loading",this.$postbox).show(),geoPosition.getCurrentPosition(function(b){a.coords=b.coords;var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);a.draw_map(c)},function(){a.draw_default_map()})):this.draw_default_map())},c.prototype.draw_default_map=function(){var a=new google.maps.LatLng(0,0);this.draw_map(a)},c.prototype.draw_map=function(a,c){if(!1===_.isBoolean(c)&&(c=!0),!1!=a instanceof google.maps.LatLng){var d=b("#pslocation-map",this.$postbox);b("#pslocation .ps-postbox-loading",this.$postbox).hide(),d.show(),this.$input_search.removeAttr("disabled");var e=this;this._latLang=a;var f={center:a,zoom:15,draggable:!1,scrollwheel:!1,disableDefaultUI:!0};if(ps_observer.apply_filters("ps_location_before_draw_map",b("#pslocation",this.$postbox)),_.isEmpty(this.map)?(this.map=new google.maps.Map(document.querySelector(d.selector),f),this.marker=new google.maps.Marker({position:f.center,map:this.map,title:"You are here (more or less)"})):this.set_map_center(this._latLang),c){var g={location:this._latLang,types:["establishment"],rankBy:google.maps.places.RankBy.DISTANCE};this.get_search_service().nearbySearch(g,function(a,b){e.set_places(a,b),e.$select_location.is(":visible")||e.$places_container.find("li").first().trigger("click")})}}},c.prototype.get_search_service=function(){return _.isEmpty(this.search_service)&&(this._search_service=new google.maps.places.PlacesService(this.map)),this._search_service},c.prototype.set_places=function(a,c){var d=this;if(this.$places_container.find("li").remove(),c===google.maps.places.PlacesServiceStatus.OK)for(var e=0;e<a.length;e++)this.add_place(a[e]);b("li",this.$places_container).on("click",function(){b(".ps-location-action",this.$container).show(),d.$select_location.show(),d.$remove_location.hide()})},c.prototype.add_place=function(a){if(_.isEmpty(a.formatted_address)||(a.vicinity=a.formatted_address),!_.isEmpty(a.vicinity)){var c=this,d=b("<li></li>");d.append("<p class='reset-gap'>"+a.name+"</p>"),d.append("<span>"+a.vicinity+"</span>"),this.$places_container.append(d),d.on("click",function(){c.set_map_center(a.geometry.location),c.$input_search.val(a.name),c.selected_place=a,c.last_selected_place=c.selected_place})}},c.prototype.set_map_center=function(a){this.map.setCenter(a),this.marker.setPosition(a)},c.prototype.load_library=function(b){if(this.gmap_is_loaded)return void b();if(this.load_library_callbacks||(this.load_library_callbacks=[]),this.load_library_callbacks.push(b),!this.gmap_is_loading){this.gmap_is_loading=!0;var c=document.createElement("script"),d=peepsogeolocationdata.api_key,e=this;c.type="text/javascript",c.src="https://maps.googleapis.com/maps/api/js?libraries=places"+(d?"&key="+d:"")+"&callback=ps_gmap_callback",a.ps_gmap_callback=function(){for(e.gmap_is_loaded=!0,e.gmap_is_loading=!1;e.load_library_callbacks.length;)e.load_library_callbacks.shift()();delete a.ps_gmap_callback},document.body.appendChild(c)}},c.prototype.show_map=function(a,c,d){peepso.lightbox([{content:'<div class="ps-js-mapct" style="width:700px;height:400px;display:inline-block" />'}],{simple:!0,afterchange:b.proxy(function(b){this.load_library(function(){var d=b.$container.find(".ps-js-mapct"),e=new google.maps.LatLng(a,c),f=new google.maps.Map(d[0],{center:e,zoom:14});new google.maps.Marker({position:e,map:f})})},this)})},ps_observer.add_filter("peepso_postbox_addons",function(a){return a.push(new c),a},10,1),c});